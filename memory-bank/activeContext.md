# アクティブコンテキスト

## 現在の作業の焦点

**フロントエンドとバックエンドの統合が完了しました！** FastAPI + SQLAlchemy + SQLiteを使用したバックエンドAPIと、Next.js + React Flow + Zustandを使用したフロントエンドが正常に連携し、LLMチャットアプリケーションとして動作しています。両サーバーが起動し、APIリクエストが正常に処理されていることを確認済みです。

## 最近の変更

*   **✅ フロントエンドとバックエンドの統合完了**:
    *   APIクライアント実装（`frontend/src/lib/api.ts`）
    *   会話ストアの拡張（バックエンドAPI統合機能追加）
    *   MessageInputコンポーネントのAPI統合
    *   Sidebarコンポーネントの会話管理機能統合
    *   CORS設定による正常な通信確立
    *   テスト用LLMプロバイダーの作成・アクティブ化
    *   両サーバーの同時起動と動作確認

*   **バックエンドAPI実装**: FastAPIを使用した包括的なRESTful API
*   **データベース設計**: SQLAlchemy + SQLiteによる会話分岐対応のデータベース構造
*   **LLMサービス統合**: OpenAI、Anthropic、Gemini、Ollamaに対応したLLMサービス
*   **会話管理API**: 会話の作成、取得、削除、ツリー構造取得機能
*   **メッセージ管理**: 親子関係を持つメッセージの保存と取得
*   **プロバイダー管理**: LLMプロバイダーの設定と切り替え機能
*   **非同期処理対応**: SQLAlchemyの非同期処理とPydantic v2対応

## 次のステップ

1.  **✅ 完了: フロントエンドとバックエンドの統合**
2.  実際のLLM統合テスト（現在はテスト用プロバイダーを使用）
3.  WebSocket/SSE通信の実装（リアルタイム応答）
4.  エラーハンドリングの強化
5.  認証・認可機能の追加（必要に応じて）

## アクティブな決定と考慮事項

*   **データベース選択**: 開発段階ではSQLiteを使用、本番環境ではPostgreSQLに切り替え可能
*   **非同期処理**: FastAPIとSQLAlchemyの非同期機能を活用
*   **API設計**: RESTful原則に従った直感的なエンドポイント設計
*   **エラーハンドリング**: HTTPステータスコードと詳細なエラーメッセージ
*   **CORS設定**: フロントエンド（localhost:3000）からのアクセスを許可

## 重要なパターンと好み

*   **会話分岐ロジック**: parent_idを使用したツリー構造でGitライクな分岐を実現
*   **LLMプロバイダー抽象化**: 統一インターフェースで複数のLLMプロバイダーに対応
*   **レスポンス構築**: SQLAlchemyのリレーションシップ問題を回避する手動レスポンス構築
*   **設定管理**: 環境変数とデータベースの組み合わせによる柔軟な設定管理

## 学習とプロジェクトの洞察

*   **SQLAlchemy非同期処理**: Pydantic v2との組み合わせで発生する問題と解決方法
*   **FastAPI設計パターン**: ルーター分離、依存性注入、ライフサイクル管理
*   **会話履歴管理**: 選択されたノードから根までの履歴構築アルゴリズム
*   **API設計**: RESTfulな設計とツリー構造データの効率的な表現方法

## 実装済み機能

### バックエンドAPI
*   **会話管理**: `/api/conversations/`
    *   POST: 新規会話作成
    *   GET: 会話一覧取得
    *   GET /{id}: 特定会話取得
    *   GET /{id}/tree: ツリー構造取得
    *   DELETE /{id}: 会話削除
    *   PUT /{id}/title: タイトル更新

*   **チャット機能**: `/api/chat/`
    *   POST /send: メッセージ送信とLLM応答
    *   GET /history/{id}: 会話履歴取得
    *   POST /regenerate/{id}: 応答再生成

*   **プロバイダー管理**: `/api/providers/`
    *   POST: プロバイダー作成
    *   GET: プロバイダー一覧
    *   GET /active: アクティブプロバイダー取得
    *   PUT /{id}: プロバイダー更新
    *   POST /{id}/activate: プロバイダー有効化
    *   POST /test/{id}: 接続テスト

### データベース構造
*   **conversations**: 会話セッション管理
*   **messages**: メッセージとツリー構造（parent_id）
*   **llm_providers**: LLMプロバイダー設定

### LLMサービス
*   **統合プロバイダー**: OpenAI、Anthropic、Gemini、Ollama
*   **コンテキスト管理**: トークン制限に応じた履歴切り詰め
*   **エラーハンドリング**: プロバイダー固有のエラー処理
