# 目的

以下の特徴を持つアプリケーションを作成する

* LLMとのチャットアプリ
* 通常のチャットアプリとは異なり、会話を遡って途中から分岐出来る。
つまり、一度LLMから応答を行った後、前のターン(ノード)を選択することで、そこから新しい流れの会話を続けることが出来る
* LLMは、現在選択されているノードから過去のノードのみ参照出来る

# UI仕様

UIは、以下から構成される

* メイン画面:
    左側サイドバー、チャット領域、ツリー表示領域で構成されている。
    * 左側サイドバー:
        * これまでのチャットの履歴一覧が表示される。サイドバー下部に新規チャット開始ボタンと設定画面表示ボタンが表示される。
        * チャット履歴一覧に表示される履歴を選択すると、選択したチャット領域とツリー表示領域の情報を復元する
        * 新規チャット開始ボタンを押すとチャット領域とツリー表示領域をクリアし、新しい履歴を先頭に追加する
        * 設定画面表示ボタンを押すと設定表示ウィンドウを表示する
    * チャット領域
        * 通常のチャット画面で上部にこれまでのLLMと人間のやり取りの会話履歴、最下部にテキスト入力用のエディットボックスが配置される。
        * エディットボックスからテキストを入力すると、これまでの会話履歴と新しい入力をLLMに送り、人間の入力とLLMからの回答を会話履歴へ下方向へ追加していく
    * ツリー表示領域:
        * これまでのやり取りを下から上に延びるツリーとして表現する。
        * ツリーのノードは人間、またはLLMの回答で、チャット領域で人間が入力したりLLMが回答するとそのツリーが延びる。
        * 各ノードは回答の最初の5文字が表示される。
        * LLMの回答ノードのみ選択可能で、選択すると左側のチャット領域がその回答を行った時に更新され、その時点から新しい会話を行うことが出来る
* 設定表示ウィンドウ:
    * OpenAI, Gemini, Claude, ollamaなどと接続のためのAPIキーやURLを入力する

# 技術スタック

- フロントエンド
    - TypeScript
    - Next.js
    - 描画ライブラリ: React Flow + zustand/recoil
    - スタイリング: Tailwind CSS (+ shadcn/ui)

- バックエンド
    - Python(uv)
    - Alembic(DB マイグレーション)
    - LLM呼び出し: openai, geminiに加え、ollamaなども対応したい

- DB: PostgreSQL

# 構成図

```
╭─React (Next.js)────────╮     WebSocket/SSE      ╭─FastAPI────────╮
│  React Flow            │◀──────────────────────▶│  LLM Service    │
│  XState (branch state) │                        │  (OpenAI / ...) │
╰──────────────┬────────╯                        ╰────────┬──────╯
               │ SQL/Graph                             │
               ▼                                       ▼
           PostgreSQL                           Ollama / OpenAI
```

# ディレクトリ構造

* frontend/ 以下に画面表示を行うフロントエンド用処理を構築する
* backend/ 以下にフロントエンド部からの通知を受けてLLMとのやり取りを行う

# 会話ブランチのロジック

* メッセージ保存
```
Messages
├─ id (PK)
├─ parent_id (NULL なら root)
├─ role (user/assistant/system)
├─ content
└─ created_at
```

* ブランチを選択したら
    1. 選んだノードから根まで parent_id をたどって逆順に並べる
    2. max_tokens 超えないよう古い方を truncate
    3. その配列だけを LLM に投げる

* 新しい問い直しは “今ノード” を親にして INSERT。どの枝からでも無限に分岐可能＝Git の `checkout -b` っぽい感じ

